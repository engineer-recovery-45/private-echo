<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PrivateEcho - AI Voice Diary</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #111;
  color: white;
  text-align: center;
  padding: 30px;
}

button {
  padding: 10px 20px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  margin: 5px;
  cursor: pointer;
}

#record { background: #e63946; color: white; }
#stop { background: #457b9d; color: white; }
#save { background: #2a9d8f; color: white; }

textarea {
  width: 90%;
  max-width: 600px;
  height: 150px;
  margin-top: 20px;
  padding: 15px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
}

#entries {
  margin-top: 40px;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  text-align: left;
}

.entry {
  background: #222;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 10px;
}

.entry small {
  opacity: 0.6;
}
</style>
</head>
<body>

<h1>ğŸ¤ PrivateEcho</h1>
<p>AI Voice Diary</p>

<button id="record">éŒ²éŸ³é–‹å§‹</button>
<button id="stop" disabled>åœæ­¢</button>
<button id="save">æ—¥è¨˜ã‚’ä¿å­˜</button>

<div id="status">ãƒ¢ãƒ‡ãƒ«æœªãƒ­ãƒ¼ãƒ‰</div>

<textarea id="output" placeholder="ã“ã“ã«æ–‡å­—èµ·ã“ã—çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>

<h2>ğŸ“š éå»ã®æ—¥è¨˜</h2>
<div id="entries"></div>

<script type="module">
import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2";

let recorder;
let chunks = [];
let transcriber;
let isModelLoading = false;

const recordBtn = document.getElementById("record");
const stopBtn = document.getElementById("stop");
const saveBtn = document.getElementById("save");
const output = document.getElementById("output");
const statusText = document.getElementById("status");
const entriesDiv = document.getElementById("entries");

// ===== ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰ =====
async function loadModel() {
  if (transcriber || isModelLoading) return;
  isModelLoading = true;
  statusText.textContent = "ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...";

  transcriber = await pipeline(
    "automatic-speech-recognition",
    "Xenova/whisper-small",
    {
      quantized: true,
      chunk_length_s: 30,
      stride_length_s: 5
    }
  );

  statusText.textContent = "ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰å®Œäº†";
}

// ===== éŒ²éŸ³ =====
recordBtn.onclick = async () => {
  await loadModel();

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  recorder = new MediaRecorder(stream);
  chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.onstop = async () => {
    statusText.textContent = "éŸ³å£°å‡¦ç†ä¸­...";

    const blob = new Blob(chunks);
    const arrayBuffer = await blob.arrayBuffer();

    const audioContext = new (window.AudioContext || window.webkitAudioContext)({
      sampleRate: 16000
    });

    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
    let channelData = audioBuffer.getChannelData(0);

    // æ­£è¦åŒ–
    let max = Math.max(...channelData.map(x => Math.abs(x)));
    if (max > 0) channelData = channelData.map(x => x / max);

    // ç„¡éŸ³ã‚«ãƒƒãƒˆ
    const threshold = 0.01;
    let start = channelData.findIndex(v => Math.abs(v) > threshold);
    let end = channelData.length - [...channelData].reverse().findIndex(v => Math.abs(v) > threshold);
    channelData = channelData.slice(start, end);

    statusText.textContent = "æ–‡å­—èµ·ã“ã—ä¸­...";

    const result = await transcriber(channelData, {
      language: "japanese",
      task: "transcribe",
      temperature: 0.0,
      beam_size: 5
    });

    output.value = result.text;
    statusText.textContent = "å®Œäº†";
  };

  recorder.start();
  recordBtn.disabled = true;
  stopBtn.disabled = false;
  statusText.textContent = "éŒ²éŸ³ä¸­...";
};

stopBtn.onclick = () => {
  recorder.stop();
  recordBtn.disabled = false;
  stopBtn.disabled = true;
};

// ===== æ—¥è¨˜ä¿å­˜ =====
saveBtn.onclick = () => {
  const text = output.value.trim();
  if (!text) return alert("å†…å®¹ãŒç©ºã§ã™");

  const diary = JSON.parse(localStorage.getItem("diary") || "[]");

  diary.unshift({
    id: Date.now(),
    date: new Date().toLocaleString(),
    text: text
  });

  localStorage.setItem("diary", JSON.stringify(diary));
  output.value = "";
  renderEntries();
};

// ===== è¡¨ç¤º =====
function renderEntries() {
  const diary = JSON.parse(localStorage.getItem("diary") || "[]");
  entriesDiv.innerHTML = "";

  diary.forEach(entry => {
    const div = document.createElement("div");
    div.className = "entry";
    div.innerHTML = `
      <small>${entry.date}</small>
      <p>${entry.text}</p>
      <button onclick="deleteEntry(${entry.id})">å‰Šé™¤</button>
    `;
    entriesDiv.appendChild(div);
  });
}

window.deleteEntry = function(id) {
  let diary = JSON.parse(localStorage.getItem("diary") || "[]");
  diary = diary.filter(entry => entry.id !== id);
  localStorage.setItem("diary", JSON.stringify(diary));
  renderEntries();
};

renderEntries();
</script>

</body>
</html>
