<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrivateEcho+ Advanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .recording-pulse { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .dark-mode { background-color: #0f172a !important; color: #f8fafc !important; }
        .dark-mode .card { background-color: #1e293b !important; border-color: #334155 !important; }
        canvas { width: 100%; height: 60px; border-radius: 8px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8 transition-colors" id="body">

<div class="max-w-2xl mx-auto space-y-6">
    <header class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-black text-indigo-600 tracking-tight">PrivateEcho+</h1>
            <p id="emotionSummary" class="text-xs text-slate-500 font-medium"></p>
        </div>
        <div class="flex gap-2">
            <button id="darkToggle" class="p-2 border rounded-full hover:bg-white transition-all text-sm">ğŸŒ™</button>
            <button id="exportBtn" class="p-2 border rounded-full hover:bg-white transition-all text-sm">ğŸ“</button>
        </div>
    </header>

    <section class="card bg-white p-6 rounded-3xl shadow-xl border border-slate-100 space-y-4">
        <div class="flex gap-2">
            <select id="modelSelect" class="bg-slate-50 text-sm border-none rounded-lg px-3 py-2 flex-1 focus:ring-2 focus:ring-indigo-500">
                <option value="Xenova/whisper-tiny">Whisper Tiny (é«˜é€Ÿ)</option>
                <option value="Xenova/whisper-base" selected>Whisper Base (æ¨™æº–)</option>
                <option value="Xenova/whisper-small">Whisper Small (é«˜ç²¾åº¦)</option>
            </select>
            <button id="loadModelBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 transition-all">
                èª­è¾¼
            </button>
        </div>

        <div id="visualizerContainer" class="hidden">
            <canvas id="canvas"></canvas>
        </div>

        <button id="recordBtn" disabled class="w-full py-4 rounded-2xl bg-slate-200 text-slate-500 font-bold text-lg transition-all flex items-center justify-center gap-2">
            <span>ğŸ™ ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</span>
        </button>
        
        <div id="status" class="text-[10px] uppercase tracking-widest text-slate-400 text-center font-bold">System Ready</div>
    </section>

    <div id="diaryList" class="space-y-4"></div>
</div>

<script>
// --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š ---
const db = new Dexie("PrivateEchoDB");
db.version(1).stores({ entries: '++id, timestamp, text, emotion, score' });

// --- çŠ¶æ…‹ç®¡ç† ---
let transcriber = null;
let recorder = null;
let chunks = [];
let audioCtx = null;
let analyser = null;
let animationId = null;

// --- æ„Ÿæƒ…åˆ†æã‚¨ãƒ³ã‚¸ãƒ³ (å¼·åŒ–ç‰ˆ) ---
const EMOTION_DICT = {
    positive: {
        words: ["å¬‰ã—ã„", "æ¥½ã—ã„", "æœ€é«˜", "å¹¸ã›", "æ„Ÿè¬", "ã§ããŸ", "æˆåŠŸ", "é¢ç™½ã„", "ãƒ¯ã‚¯ãƒ¯ã‚¯", "å¥½ã", "æ„Ÿå‹•", "æº€è¶³", "å……å®Ÿ", "ãƒªãƒ©ãƒƒã‚¯ã‚¹", "ç´ æ™´ã‚‰ã—ã„", "çµ¶å¥½èª¿", "ã„ã„æ„Ÿã˜", "ç¬‘"],
        score: 1
    },
    negative: {
        words: ["è¾›ã„", "ç–²ã‚ŒãŸ", "æœ€æ‚ª", "æ‚²ã—ã„", "è‹¦ã—ã„", "æ€’ã‚Š", "å¤±æ•—", "ä¸å®‰", "å«Œã ", "ã ã‚‹ã„", "è½ã¡è¾¼ã‚€", "ã‚·ãƒ§ãƒƒã‚¯", "å¯‚ã—ã„", "ã‚¤ãƒ©ã‚¤ãƒ©", "ãƒ€ãƒ¡", "å¾Œæ‚”", "æ­»ã¬", "é…·ã„"],
        score: -1
    }
};

function analyzeEmotion(text) {
    let score = 0;
    EMOTION_DICT.positive.words.forEach(w => { if(text.includes(w)) score += 1; });
    EMOTION_DICT.negative.words.forEach(w => { if(text.includes(w)) score -= 1; });
    
    // æ–‡æœ«ã®å¦å®šï¼ˆã€œãªã„ï¼‰ã‚’ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
    if (text.includes("ããªã„") || text.includes("ã˜ã‚ƒãªã„") || text.includes("ãªã‹ã£ãŸ")) {
        score *= -0.5; // ã‚¹ã‚³ã‚¢ã‚’åè»¢ãƒ»æ¸›è¡°ã•ã›ã‚‹
    }

    if (score > 0.5) return { label: "positive", emoji: "âœ¨", score };
    if (score < -0.5) return { label: "negative", emoji: "ğŸ’§", score };
    return { label: "neutral", emoji: "â˜ï¸", score };
}

// --- ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼æç”» ---
function drawVisualizer() {
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const dataArray = new Uint8Array(analyser.frequencyBinCount);
    
    function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#6366f1';
        const barWidth = (canvas.width / dataArray.length) * 2.5;
        let x = 0;
        for(let i = 0; i < dataArray.length; i++) {
            const barHeight = (dataArray[i] / 255) * canvas.height;
            ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
            x += barWidth + 1;
        }
    }
    draw();
}

// --- AI åˆæœŸåŒ– ---
async function initAI() {
    const btn = document.getElementById("loadModelBtn");
    const recBtn = document.getElementById("recordBtn");
    btn.disabled = true;
    updateStatus("Model Downloading...");
    
    try {
        const { pipeline, env } = await import('https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js');
        env.allowLocalModels = false;
        
        transcriber = await pipeline('automatic-speech-recognition', document.getElementById("modelSelect").value);
        
        updateStatus("AI Engine Online");
        recBtn.disabled = false;
        recBtn.classList.replace("bg-slate-200", "bg-indigo-600");
        recBtn.classList.replace("text-slate-500", "text-white");
        recBtn.innerHTML = "ğŸ™ éŒ²éŸ³ã‚’é–‹å§‹ã™ã‚‹";
        btn.innerText = "OK";
    } catch (e) {
        updateStatus("Error: " + e.message);
    }
}

// --- éŒ²éŸ³åˆ¶å¾¡ ---
async function toggleRecording() {
    if (recorder && recorder.state === "recording") {
        recorder.stop();
        stopVisualizer();
        return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    const source = audioCtx.createMediaStreamSource(stream);
    source.connect(analyser);
    
    document.getElementById("visualizerContainer").classList.remove("hidden");
    drawVisualizer();

    recorder = new MediaRecorder(stream);
    chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = async () => {
        stream.getTracks().forEach(t => t.stop());
        processAudio();
    };

    recorder.start();
    updateStatus("Listening...");
    const rb = document.getElementById("recordBtn");
    rb.innerHTML = "â¹ éŒ²éŸ³ã‚’çµ‚äº†";
    rb.classList.add("recording-pulse", "bg-red-500");
}

function stopVisualizer() {
    cancelAnimationFrame(animationId);
    document.getElementById("visualizerContainer").classList.add("hidden");
}

async function processAudio() {
    updateStatus("Transcribing...");
    const blob = new Blob(chunks, { type: 'audio/webm' });
    const buffer = await blob.arrayBuffer();
    const decoded = await audioCtx.decodeAudioData(buffer);
    const audioData = decoded.getChannelData(0);

    const result = await transcriber(audioData, { 
        language: 'japanese',
        task: 'transcribe',
        chunk_length_s: 30,
        stride_length_s: 5,
        repetition_penalty: 1.2 // ç¹°ã‚Šè¿”ã—ã‚’æŠ‘åˆ¶
    });

    const text = result.text.trim();
    if(text) {
        const emotionData = analyzeEmotion(text);
        await db.entries.add({
            timestamp: Date.now(),
            text: text,
            emotion: emotionData.label,
            score: emotionData.score
        });
        render();
    }
    
    updateStatus("Saved");
    resetRecordBtn();
}

function resetRecordBtn() {
    const rb = document.getElementById("recordBtn");
    rb.innerHTML = "ğŸ™ éŒ²éŸ³ã‚’é–‹å§‹ã™ã‚‹";
    rb.classList.remove("recording-pulse", "bg-red-500");
    rb.classList.add("bg-indigo-600");
}

function updateStatus(msg) {
    document.getElementById("status").innerText = msg;
}

// --- ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ---
async function render() {
    const entries = await db.entries.orderBy("timestamp").reverse().toArray();
    const list = document.getElementById("diaryList");
    list.innerHTML = "";

    let stats = { positive: 0, negative: 0, neutral: 0 };
    
    entries.forEach(e => {
        stats[e.emotion]++;
        const card = document.createElement("div");
        const emoji = analyzeEmotion(e.text).emoji;
        const bgColor = e.emotion === 'positive' ? 'bg-emerald-50' : (e.emotion === 'negative' ? 'bg-rose-50' : 'bg-white');
        
        card.className = `card p-5 rounded-2xl border border-slate-100 ${bgColor} shadow-sm transition-all hover:shadow-md`;
        card.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">${new Date(e.timestamp).toLocaleString()}</span>
                <span class="text-xl">${emoji}</span>
            </div>
            <p class="text-slate-700 leading-relaxed text-sm font-medium">${e.text}</p>
            <button onclick="deleteEntry(${e.id})" class="mt-4 text-[10px] font-bold text-slate-400 hover:text-red-500 transition-colors uppercase tracking-widest">Delete</button>
        `;
        list.appendChild(card);
    });

    document.getElementById("emotionSummary").innerText = `POS ${stats.positive} / NEU ${stats.neutral} / NEG ${stats.negative}`;
}

async function deleteEntry(id) {
    if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        await db.entries.delete(id);
        render();
    }
}

// --- ã‚¤ãƒ™ãƒ³ãƒˆ ---
document.getElementById("loadModelBtn").onclick = initAI;
document.getElementById("recordBtn").onclick = toggleRecording;
document.getElementById("darkToggle").onclick = () => {
    document.body.classList.toggle("dark-mode");
};
document.getElementById("exportBtn").onclick = async () => {
    const data = await db.entries.toArray();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'diary-export.json';
    a.click();
};

render();
</script>
</body>
</html>
